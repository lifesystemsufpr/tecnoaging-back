name: DEV - Build and Deploy to Backend Server

on:
  push:
    branches:
      - dev_v2

jobs:
  deploy:
    name: Build and Deploy to Backend Server
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash

    env:
      SSH_HOST: ${{ secrets.DEV_SSH_HOST || vars.DEV_SSH_HOST }}
      SSH_USER: ${{ secrets.SSH_USER || vars.SSH_USER }}
      SSH_PORT: ${{ secrets.SSH_PORT || vars.SSH_PORT }}
      APP_DIR:  tecnoaging-back
      PM2_APP:  TecnoAging-api
      PM2_PY_APP: TecnoAging-python

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEV_SSH_PRIVATE_KEY }}

      - name: Validar secrets/variáveis
        env:
          SSH_PRIVATE_KEY: ${{ secrets.DEV_SSH_PRIVATE_KEY }}
          DATABASE_URL:    ${{ secrets.DEV_DATABASE_URL }}
          JWT_SECRET:      ${{ secrets.JWT_SECRET }}
        run: |
          set -euo pipefail
          
          for v in SSH_PRIVATE_KEY SSH_HOST SSH_USER APP_DIR DATABASE_URL JWT_SECRET; do
            if [[ -z "${!v:-}" ]]; then
              echo "::error title=Missing::$v está vazio."
              exit 1
            fi
          done
          if [[ -z "${SSH_PORT:-}" ]]; then
            echo "SSH_PORT não definido, usando 22"
          fi

      - name: known_hosts
        run: |
          set -e
          mkdir -p ~/.ssh
          ssh-keyscan -p "${SSH_PORT:-22}" -H "${SSH_HOST}" >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Install Dependencies (Runner)
        run: npm ci

      - name: Build Application (Runner)
        run: npm run build

      - name: Create .env file
        run: |
          set -euo pipefail
          
          # Reconstructs the .env file variable by variable
          DB_URL="postgresql://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@${{ secrets.DEV_POSTGRES_HOST }}:${{ secrets.POSTGRES_PORT }}/${{ secrets.POSTGRES_DB }}?schema=public"
          
          {
            echo "DATABASE_URL=${DB_URL}"
            echo "JWT_SECRET=${{ secrets.JWT_SECRET }}"
            echo "JWT_EXPIRES_IN=86400"
            echo "JWT_REFRESH_EXPIRES_IN=604800"
            echo "NODE_ENV=${{ secrets.NODE_ENV || 'production' }}"
            echo "NEST_PORT=3333"
            echo "HEALTH_HEAP_LIMIT_MB=200"
            echo "HEALTH_RSS_LIMIT_MB=300"
            echo "PYTHON_SERVICE_URL=http://localhost:8001"
          } > .env

      - name: Prepare Artifacts
        run: |
          mkdir deploy_artifact
          cp -r dist package.json package-lock.json prisma .env ecosystem.config.js python-service deploy_artifact/
      
      - name: Transfer Files
        run: |
          set -euo pipefail
          ssh -p "${SSH_PORT:-22}" "${SSH_USER}@${SSH_HOST}" "mkdir -p ~/${APP_DIR}"
          
          # Use rsync to send artifacts to the server
          # Using --delete to ensure the remote directory mirrors the artifacts (clean state)
          rsync -avz --delete \
            -e "ssh -p ${SSH_PORT:-22}" \
            deploy_artifact/ \
            "${SSH_USER}@${SSH_HOST}:~/${APP_DIR}/"

      - name: Deploy on Server
        run: |
          set -euo pipefail
          ssh -p "${SSH_PORT:-22}" \
            -o StrictHostKeyChecking=no \
            -o BatchMode=yes \
            -o LogLevel=ERROR \
            -o ServerAliveInterval=30 -o ServerAliveCountMax=6 \
            "${SSH_USER}@${SSH_HOST}" \
            "APP_DIR='${APP_DIR}' PM2_APP='${PM2_APP}' PM2_PY_APP='${PM2_PY_APP}' bash -se" <<'EOF'
          set -euo pipefail

          # Load Node/NVM
          if [ -d "$HOME/.nvm" ]; then
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
            command -v node >/dev/null 2>&1 || nvm use --lts || true
          fi

          cd ~/"${APP_DIR}"
          
          # Configurar Python Service
          # Tenta instalar Python se não existir
          if ! command -v python3 >/dev/null 2>&1; then
            echo "Python 3 não encontrado. Instalando..."
            sudo apt-get update
            sudo apt-get install -y python3 python3-pip python3-venv
          fi

          if command -v python3 >/dev/null 2>&1; then
            echo "Configurando Python..."
            
            # Garante que o venv existe
            if [ ! -d "python-service/venv" ]; then
              echo "Criando venv em python-service/venv..."
              if ! python3 -m venv python-service/venv; then
                  echo "Venv falhou. Tentando instalar pacote python3-venv..."
                  rm -rf python-service/venv
                  
                  # Detecta versão (ex: 3.10)
                  PY_VERSION=$(python3 -c 'import sys; print(f"{sys.version_info.major}.{sys.version_info.minor}")')
                  sudo apt-get update
                  sudo apt-get install -y "python${PY_VERSION}-venv" "python${PY_VERSION}-dev" || sudo apt-get install -y python3-venv python3-dev
                  
                  echo "Tentando criar venv novamente..."
                  python3 -m venv python-service/venv
              fi
            fi
            
            # Instala dependências
            echo "Instalando dependências Python..."
            ./python-service/venv/bin/pip install -r python-service/requirements.txt
          else
            echo "ERRO CRÍTICO: Não foi possível instalar ou encontrar o Python 3."
            exit 1
          fi

          # Install production dependencies for Node
          if command -v npm >/dev/null 2>&1; then
            npm ci --production
          else
            echo "npm não encontrado"; exit 1
          fi

          # Run DB migrations
          if [ -d "prisma" ]; then
             npx prisma migrate deploy
          fi

          command -v pm2 >/dev/null 2>&1 || npm install -g pm2

          # Clean restart with PM2
          # REMOVER processos antigos completamente para garantir recarregamento de variáveis
          pm2 delete "${PM2_PY_APP}" || true
          pm2 delete "${PM2_APP}" || true
          
          # Start application using ecosystem.config.js
          if [ -f ecosystem.config.js ]; then
            pm2 start ecosystem.config.js --update-env
          else
            echo "ecosystem.config.js not found, falling back to simple start"
            pm2 start dist/main.js --name "${PM2_APP}" --update-env
          fi

          pm2 save || true
          exit 0
          EOF

