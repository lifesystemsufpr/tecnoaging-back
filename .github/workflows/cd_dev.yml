name: DEVENV - Deploy Backend

on:
  push:
    branches:
      - dev

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy Backend (DEVENV)
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash

    env:
      SSH_HOST: ${{ secrets.DEVENV_SSH_HOST }}
      SSH_USER: ${{ secrets.DEVENV_SSH_USER }}
      SSH_PORT: ${{ secrets.DEVENV_SSH_PORT }}

      APP_DIR: /opt/tecnoaging/back

      PM2_APP: TecnoAging-api
      PM2_PY_APP: TecnoAging-python

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: Debug workspace
        run: |
          pwd
          ls -la
      
      # Instalação limpa no runner (CORRETO)
      - name: Install dependencies (CI)
        run: npm ci

      - name: Build backend
        run: npm run build

      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEVENV_SSH_PRIVATE_KEY }}

      - name: Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p "${SSH_PORT}" -H "${SSH_HOST}" >> ~/.ssh/known_hosts

      - name: Prepare deploy artifact
        run: |
          rm -rf deploy_artifact
          mkdir deploy_artifact

          cp -r dist deploy_artifact/
          cp package.json package-lock.json deploy_artifact/

          [ -d prisma ] && cp -r prisma deploy_artifact/
          [ -f ecosystem.config.js ] && cp ecosystem.config.js deploy_artifact/
          [ -d python-service ] && cp -r python-service deploy_artifact/

      - name: Deploy artifact to server
        run: |
          ssh -p "${SSH_PORT}" "${SSH_USER}@${SSH_HOST}" "mkdir -p ${APP_DIR}"

          rsync -avz --delete \
            --exclude=".env" \
            --exclude="logs/" \
            -e "ssh -p ${SSH_PORT}" \
            deploy_artifact/ \
            "${SSH_USER}@${SSH_HOST}:${APP_DIR}/"

      - name: Install production dependencies on server
        run: |
          ssh -p "${SSH_PORT}" "${SSH_USER}@${SSH_HOST}" << EOF
            set -e
            cd "${APP_DIR}"

            rm -rf node_modules
            npm install --omit=dev --no-audit --no-fund
          EOF

      - name: Run Prisma migrations
        run: |
          ssh -p "${SSH_PORT}" "${SSH_USER}@${SSH_HOST}" << EOF
            cd "${APP_DIR}"
            export \$(grep -v '^#' .env | xargs)
            npx prisma migrate deploy
          EOF

      - name: Restart backend services
        run: |
          ssh -p "${SSH_PORT}" "${SSH_USER}@${SSH_HOST}" << EOF
            cd "${APP_DIR}"
            pm2 reload ecosystem.config.js --env development
            pm2 save
          EOF